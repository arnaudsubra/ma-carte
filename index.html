<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte des lieux d√©march√©s</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-bottom: 1rem; }
    form { margin-bottom: 1rem; }
    label { display: block; margin-top: 0.5rem; }
    input, select, textarea { width: 100%; padding: 0.5rem; }
    .button-container { margin-top: 1rem; }
    .button-container button { margin-right: 1rem; }
  </style>
</head>
<body>
  <h1>üõòÔ∏è Carte des lieux d√©march√©s</h1>
  <div id="map"></div>
  <form id="lieu-form">
    <label for="nom">Nom du lieu :</label>
    <input type="text" id="nom" required>

    <label for="adresse">Adresse ou ville :</label>
    <input type="text" id="adresse" required>

    <label for="type">Type de lieu :</label>
    <input type="text" id="type">

    <label for="date">Date (optionnel) :</label>
    <input type="text" id="date">

    <label for="remarques">Remarques :</label>
    <textarea id="remarques"></textarea>

    <label for="statut">Statut :</label>
    <select id="statut">
      <option value="en_attente">En attente</option>
      <option value="a_relancer">√Ä relancer</option>
      <option value="confirme">Confirm√©</option>
    </select>

    <div class="button-container">
      <button type="submit">Ajouter ou mettre √† jour</button>
      <button type="button" id="export-btn">Exporter</button>
      <button type="button" id="clear-btn">Tout effacer</button>
    </div>

    <input type="file" id="import-file">
  </form>

  <div id="liste-lieux"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([44.8378, -0.5792], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};

    const couleurParStatut = {
      en_attente: 'blue',
      a_relancer: 'red',
      confirme: 'green'
    };

    function ajouterMarqueur(lieu) {
      const geocoder = new L.Control.Geocoder.Nominatim();
      geocoder.geocode(lieu.adresse, function(results) {
        if (results.length === 0) return;
        const latlng = results[0].center;
        const marker = L.circleMarker(latlng, {
          radius: 8,
          color: couleurParStatut[lieu.statut] || 'gray',
          fillOpacity: 0.9
        }).addTo(map);
        marker.bindPopup(`<strong>${lieu.nom}</strong><br>${lieu.adresse}`);
        markers[lieu.nom] = marker;
      });
    }

    function afficherLieux() {
      const liste = document.getElementById('liste-lieux');
      liste.innerHTML = '';
      const lieux = JSON.parse(localStorage.getItem('lieux') || '[]');
      lieux.forEach((lieu, index) => {
        const div = document.createElement('div');
        div.innerHTML = `<p><strong>${lieu.nom}</strong><br>${lieu.adresse}<br>${lieu.type}<br>${lieu.date}<br>${lieu.remarques || ''}</p>`;
        const btnModif = document.createElement('button');
        btnModif.textContent = '‚úèÔ∏è Modifier';
        btnModif.onclick = () => remplirFormulaire(lieu);
        const btnSuppr = document.createElement('button');
        btnSuppr.textContent = 'Supprimer';
        btnSuppr.onclick = () => supprimerLieu(index);
        div.appendChild(btnModif);
        div.appendChild(btnSuppr);
        liste.appendChild(div);
      });
    }

    function remplirFormulaire(lieu) {
      document.getElementById('nom').value = lieu.nom;
      document.getElementById('adresse').value = lieu.adresse;
      document.getElementById('type').value = lieu.type;
      document.getElementById('date').value = lieu.date;
      document.getElementById('remarques').value = lieu.remarques;
      document.getElementById('statut').value = lieu.statut;
    }

    function supprimerLieu(index) {
      const lieux = JSON.parse(localStorage.getItem('lieux') || '[]');
      lieux.splice(index, 1);
      localStorage.setItem('lieux', JSON.stringify(lieux));
      afficherLieux();
    }

    document.getElementById('lieu-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const lieu = {
        nom: document.getElementById('nom').value,
        adresse: document.getElementById('adresse').value,
        type: document.getElementById('type').value,
        date: document.getElementById('date').value,
        remarques: document.getElementById('remarques').value,
        statut: document.getElementById('statut').value
      };
      let lieux = JSON.parse(localStorage.getItem('lieux') || '[]');
      const index = lieux.findIndex(l => l.nom === lieu.nom);
      if (index >= 0) lieux[index] = lieu;
      else lieux.push(lieu);
      localStorage.setItem('lieux', JSON.stringify(lieux));
      ajouterMarqueur(lieu);
      afficherLieux();
      this.reset();
    });

    document.getElementById('export-btn').onclick = function() {
      const data = localStorage.getItem('lieux');
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'lieux.json';
      a.click();
    };

    document.getElementById('clear-btn').onclick = function() {
      if (confirm('Tout effacer ?')) {
        localStorage.removeItem('lieux');
        location.reload();
      }
    };

    document.getElementById('import-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        localStorage.setItem('lieux', event.target.result);
        location.reload();
      };
      reader.readAsText(file);
    });

    const lieux = JSON.parse(localStorage.getItem('lieux') || '[]');
    lieux.forEach(ajouterMarqueur);
    afficherLieux();
  </script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</body>
</html>
